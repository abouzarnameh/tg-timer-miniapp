<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ØªØ§ÛŒÙ…Ø±Ù‡Ø§ÛŒ Ú¯Ø±ÙˆÙ‡</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root { --bd:#e6e6e6; --muted:#6b7280; }
    body { font-family: sans-serif; padding: 14px; margin: 0; }
    h3 { margin: 0 0 8px 0; }
    .muted { color: var(--muted); font-size: 13px; margin-bottom: 10px; line-height: 1.6; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin: 10px 0 14px; }
    .pill { border:1px solid var(--bd); border-radius:999px; padding:6px 10px; font-size:13px; }
    .list { margin-top: 10px; }
    .card {
      border: 1px solid var(--bd);
      border-radius: 14px;
      padding: 12px;
      margin: 10px 0;
    }
    .title { font-weight: 800; margin-bottom: 8px; display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .badge { font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid var(--bd); color: #111; }
    .time { font-size: 22px; font-weight: 800; letter-spacing: 1px; }
    .sub { margin-top: 8px; color: var(--muted); font-size: 13px; display:flex; gap:12px; flex-wrap:wrap; }
    .err {
      border: 1px solid #fca5a5;
      background: #fff1f2;
      color: #9f1239;
      padding: 10px;
      border-radius: 12px;
      line-height: 1.6;
      margin-top: 12px;
      white-space: pre-wrap;
    }
    .btn {
      display:inline-block;
      padding:10px 12px;
      border-radius: 12px;
      border: 1px solid var(--bd);
      background: white;
      cursor: pointer;
      font-weight: 700;
    }
    .btn:active { transform: scale(0.99); }
  </style>
</head>

<body>
  <h3>ØªØ§ÛŒÙ…Ø±Ù‡Ø§ÛŒ Ú¯Ø±ÙˆÙ‡</h3>
  <div class="muted" id="meta">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</div>

  <div class="row" id="chips" style="display:none;">
    <span class="pill" id="chipSid"></span>
    <span class="pill" id="chipStatus"></span>
    <span class="pill" id="chipCount"></span>
  </div>

  <div class="row">
    <button class="btn" id="btnStart" style="display:none;">â–¶ï¸ Ø´Ø±ÙˆØ¹ Ù‡Ù…Ù‡</button>
    <button class="btn" id="btnRefresh">ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
  </div>

  <div class="list" id="list"></div>
  <div id="error" class="err" style="display:none;"></div>

  <script>
    // ========= ØªÙ†Ø¸ÛŒÙ…Ø§Øª =========
    const API_BASE = "https://tg-timer-api.onrender.com";

    // ========= ØªÙ„Ú¯Ø±Ø§Ù… =========
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.ready();
      tg.expand?.();
    }

    // ========= Helpers =========
    function qs(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    function showError(text) {
      const el = document.getElementById("error");
      el.style.display = "block";
      el.textContent = text;
    }

    function clearError() {
      const el = document.getElementById("error");
      el.style.display = "none";
      el.textContent = "";
    }

    function setMeta(text) {
      document.getElementById("meta").textContent = text;
    }

    function fmt(ms) {
      ms = Math.max(0, ms);
      const s = Math.floor(ms / 1000);
      const hh = Math.floor(s / 3600);
      const mm = Math.floor((s % 3600) / 60);
      const ss = s % 60;
      return `${String(hh).padStart(2,'0')}.${String(mm).padStart(2,'0')}.${String(ss).padStart(2,'0')}`;
    }

    function statusLabel(status) {
      if (status === "pending") return "Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø´Ø±ÙˆØ¹";
      if (status === "running") return "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§";
      if (status === "stopped") return "Ù…ØªÙˆÙ‚Ù Ø´Ø¯Ù‡";
      if (status === "deleted") return "Ø­Ø°Ù Ø´Ø¯Ù‡";
      return status || "-";
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ========= State =========
    const sid = qs("sid");
    let session = null;
    let items = [];

    const btnStart = document.getElementById("btnStart");
    const btnRefresh = document.getElementById("btnRefresh");

    btnRefresh.onclick = async () => { await load(); render(); };

    btnStart.onclick = async () => {
      if (!sid) return;
      try {
        clearError();
        const r = await fetch(`${API_BASE}/session/${encodeURIComponent(sid)}/start`, { method: "POST" });
        const data = await r.json();
        if (data.error) {
          showError("Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹: " + data.error);
          return;
        }
        await load();
        render();
      } catch (e) {
        showError("Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹: " + String(e));
      }
    };

    async function load() {
      if (!sid) {
        setMeta("âŒ sid Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. Ø¨Ø§ÛŒØ¯ Ø§Ø² Ù„ÛŒÙ†Ú© Ø¨Ø§Øª ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒ (Ù…Ø«Ù„Ø§Ù‹ .../?sid=12).");
        document.getElementById("chips").style.display = "none";
        document.getElementById("list").innerHTML = "";
        btnStart.style.display = "none";
        return;
      }

      try {
        clearError();

        const res = await fetch(`${API_BASE}/session?sid=${encodeURIComponent(sid)}`, {
          method: "GET",
          headers: { "Accept": "application/json" },
        });

        if (!res.ok) throw new Error(`API error: ${res.status} ${res.statusText}`);
        const data = await res.json();

        if (data.error) {
          // Ù…Ø«Ù„Ø§ not_found
          session = null;
          items = [];
          setMeta(`sid=#${sid} | Ø®Ø·Ø§: ${data.error}`);
          document.getElementById("chips").style.display = "flex";
          document.getElementById("chipSid").textContent = `SID: ${sid}`;
          document.getElementById("chipStatus").textContent = `Status: -`;
          document.getElementById("chipCount").textContent = `Count: 0`;
          btnStart.style.display = "none";
          showError("Ø§ÛŒÙ† sid Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ù‡Ù†ÙˆØ² ØªÙˆØ³Ø· Ø¨Ø§Øª Ø³Ø§Ø®ØªÙ‡ Ù†Ø´Ø¯Ù‡.");
          return;
        }

        session = data.session;
        items = Array.isArray(data.items) ? data.items : [];

        const chatId = tg?.initDataUnsafe?.chat?.id;
        const chatType = tg?.initDataUnsafe?.chat_type;

        setMeta(
          `sid=#${sid} | ÙˆØ¶Ø¹ÛŒØª: ${statusLabel(session?.status)}`
          + (chatId ? ` | chat_id: ${chatId}` : "")
          + (chatType ? ` | chat_type: ${chatType}` : "")
        );

        document.getElementById("chips").style.display = "flex";
        document.getElementById("chipSid").textContent = `SID: ${sid}`;
        document.getElementById("chipStatus").textContent = `Status: ${statusLabel(session?.status)}`;
        document.getElementById("chipCount").textContent = `Count: ${items.length}`;

        // Ø§Ú¯Ø± pending Ø¨ÙˆØ¯ØŒ Ø¯Ú©Ù…Ù‡ Ø´Ø±ÙˆØ¹ Ø±Ùˆ Ù†Ø´ÙˆÙ† Ø¨Ø¯Ù‡
        btnStart.style.display = (session?.status === "pending") ? "inline-block" : "none";

      } catch (e) {
        showError(
          `Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ø§Ø² Ø³Ø±ÙˆØ±.\n\n` +
          `Ø¬Ø²Ø¦ÛŒØ§Øª Ø®Ø·Ø§:\n${String(e)}`
        );
      }
    }

    function render() {
      const list = document.getElementById("list");

      if (!sid) {
        list.innerHTML = "";
        return;
      }

      if (!session) {
        list.innerHTML = `<div class="muted">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</div>`;
        return;
      }

      if (!items.length) {
        list.innerHTML = `<div class="muted">Ù‡ÛŒÚ† ØªØ§ÛŒÙ…Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø³Ø´Ù† Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</div>`;
        return;
      }

      const now = Date.now();

      // Ø§Ú¯Ø± Ù‡Ù†ÙˆØ² Ø´Ø±ÙˆØ¹ Ù†Ø´Ø¯Ù‡: ÙÙ‚Ø· Ù…Ø¯Øªâ€ŒÙ‡Ø§ Ø±Ùˆ Ù†Ø´ÙˆÙ† Ø¨Ø¯Ù‡
      if (session.status === "pending" || !session.started_at_ms) {
        list.innerHTML = items
          .sort((a,b) => (a.order_index ?? 0) - (b.order_index ?? 0))
          .map((t, idx) => `
            <div class="card">
              <div class="title">
                <span>#${idx+1} ${t.title ? `â€” ${escapeHtml(t.title)}` : ""}</span>
                <span class="badge">Ø«Ø¨Øª Ø´Ø¯Ù‡</span>
              </div>
              <div class="time">${fmt(Number(t.duration_ms || 0))}</div>
              <div class="sub">
                <span>Ù…Ø¯Øª: ${fmt(Number(t.duration_ms || 0))}</span>
              </div>
            </div>
          `).join("");
        return;
      }

      // ===== Ø­Ø§Ù„Øª running: Ù‡Ù…Ù‡ Ù‡Ù…Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ =====
      const startedAt = Number(session.started_at_ms);

      list.innerHTML = items
        .sort((a,b) => (a.order_index ?? 0) - (b.order_index ?? 0))
        .map((t, idx) => {
          const endAt = startedAt + Number(t.duration_ms || 0);
          const left = endAt - now;
          const isDone = left <= 0;

          const badge = isDone ? "ØªÙ…Ø§Ù… Ø´Ø¯" : "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§";

          return `
            <div class="card">
              <div class="title">
                <span>#${idx+1} ${t.title ? `â€” ${escapeHtml(t.title)}` : ""}</span>
                <span class="badge">${badge}</span>
              </div>
              <div class="time">${fmt(left)}</div>
              <div class="sub">
                <span>Ù…Ø¯Øª: ${fmt(Number(t.duration_ms || 0))}</span>
              </div>
            </div>
          `;
        }).join("");
    }

    (async () => {
      await load();
      render();

      // Ù„Ø§ÛŒÙˆ
      setInterval(render, 200);

      // Ø³ÛŒÙ†Ú© Ø³Ø¨Ú©
      setInterval(load, 5000);
    })();
  </script>
</body>
</html>
