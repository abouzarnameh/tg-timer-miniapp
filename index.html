<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Timers</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root { --bd:#e6e6e6; --muted:#6b7280; }
    body { font-family: sans-serif; padding: 14px; margin: 0; }
    h3 { margin: 0 0 8px 0; }
    .muted { color: var(--muted); font-size: 13px; margin-bottom: 10px; line-height: 1.6; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin: 10px 0 14px; }
    .pill { border:1px solid var(--bd); border-radius:999px; padding:6px 10px; font-size:13px; }
    .card {
      border: 1px solid var(--bd);
      border-radius: 14px;
      padding: 12px;
      margin: 10px 0;
    }
    .title { font-weight: 800; margin-bottom: 8px; display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .badge { font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid var(--bd); color: #111; }
    .time { font-size: 22px; font-weight: 800; letter-spacing: 1px; }
    .sub { margin-top: 8px; color: var(--muted); font-size: 13px; display:flex; gap:12px; flex-wrap:wrap; }
    .err {
      border: 1px solid #fca5a5;
      background: #fff1f2;
      color: #9f1239;
      padding: 10px;
      border-radius: 12px;
      line-height: 1.6;
      margin-top: 12px;
      white-space: pre-wrap;
    }
    .btn {
      display:inline-block;
      padding:10px 12px;
      border-radius: 12px;
      border: 1px solid var(--bd);
      background: white;
      cursor: pointer;
      font-weight: 800;
      text-decoration: none;
      color: #111;
    }
    .btn:active { transform: scale(0.99); }

    .inp {
      padding:10px 12px;
      border-radius: 12px;
      border: 1px solid var(--bd);
      outline: none;
      font-weight: 700;
      width: 160px;
    }
    .inp2 {
      padding:10px 12px;
      border-radius: 12px;
      border: 1px solid var(--bd);
      outline: none;
      font-weight: 700;
      width: 220px;
    }
  </style>
</head>

<body>
  <h3 id="pageTitle">ØªØ§ÛŒÙ…Ø±Ù‡Ø§ÛŒ Ù…Ù†</h3>
  <div class="muted" id="meta">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</div>

  <div class="row" id="chips" style="display:none;">
    <span class="pill" id="chipInfo"></span>
  </div>

  <div class="row" id="controls" style="display:none;">
    <input class="inp" id="inpTime" placeholder="00.00.00" />
    <input class="inp2" id="inpTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" />
    <button class="btn" id="btnAdd">â• Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†</button>
  </div>

  <div class="row" id="controls2" style="display:none;">
    <button class="btn" id="btnStart" style="display:none;">â–¶ï¸ Ø´Ø±ÙˆØ¹ Ù‡Ù…Ù‡</button>
    <button class="btn" id="btnRefresh">ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
  </div>

  <div id="content"></div>
  <div id="error" class="err" style="display:none;"></div>

  <script>
    const API_BASE = "https://tg-timer-api.onrender.com";

    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand?.(); }

    function showError(text) {
      const el = document.getElementById("error");
      el.style.display = "block";
      el.textContent = text;
    }

    function clearError() {
      const el = document.getElementById("error");
      el.style.display = "none";
      el.textContent = "";
    }

    function setMeta(text) {
      document.getElementById("meta").textContent = text;
    }

    function fmt(ms) {
      ms = Math.max(0, ms);
      const s = Math.floor(ms / 1000);
      const hh = Math.floor(s / 3600);
      const mm = Math.floor((s % 3600) / 60);
      const ss = s % 60;
      return `${String(hh).padStart(2,'0')}.${String(mm).padStart(2,'0')}.${String(ss).padStart(2,'0')}`;
    }

    function statusLabel(status) {
      if (status === "pending") return "Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø´Ø±ÙˆØ¹";
      if (status === "running") return "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§";
      if (status === "stopped") return "Ù…ØªÙˆÙ‚Ù Ø´Ø¯Ù‡";
      if (status === "deleted") return "Ø­Ø°Ù Ø´Ø¯Ù‡";
      return status || "-";
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function parseTimeToMs(text) {
      text = String(text).trim();
      const parts = text.split(".");
      if (parts.length !== 3) throw new Error("ÙØ±Ù…Øª Ø¨Ø§ÛŒØ¯ HH.MM.SS Ø¨Ø§Ø´Ø¯ (Ù…Ø«Ù„Ø§Ù‹ 01.22.30)");

      const hh = parseInt(parts[0]);
      const mm = parseInt(parts[1]);
      const ss = parseInt(parts[2]);

      if (isNaN(hh) || isNaN(mm) || isNaN(ss)) throw new Error("Ø¹Ø¯Ø¯Ù‡Ø§ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³ØªÙ†Ø¯");
      if (mm < 0 || mm > 59) throw new Error("Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 00 ØªØ§ 59 Ø¨Ø§Ø´Ø¯");
      if (ss < 0 || ss > 59) throw new Error("Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 00 ØªØ§ 59 Ø¨Ø§Ø´Ø¯");

      const total = hh * 3600 + mm * 60 + ss;
      if (total <= 0) throw new Error("Ø²Ù…Ø§Ù† Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² ØµÙØ± Ø¨Ø§Ø´Ø¯");

      return total * 1000;
    }

    // DOM
    const content = document.getElementById("content");
    const controls = document.getElementById("controls");
    const controls2 = document.getElementById("controls2");

    const chips = document.getElementById("chips");
    const chipInfo = document.getElementById("chipInfo");

    const inpTime = document.getElementById("inpTime");
    const inpTitle = document.getElementById("inpTitle");

    const btnAdd = document.getElementById("btnAdd");
    const btnStart = document.getElementById("btnStart");
    const btnRefresh = document.getElementById("btnRefresh");

    // State
    let creatorId = null;
    let sid = null;
    let session = null;
    let items = [];

    async function getPendingSession() {
      const res = await fetch(`${API_BASE}/session/pending_simple?creator_id=${encodeURIComponent(creatorId)}`, {
        method: "POST",
        headers: { "Accept": "application/json" },
      });

      if (!res.ok) throw new Error(`API error: ${res.status} ${res.statusText}`);
      const data = await res.json();
      if (!data.sid) throw new Error("API sid Ù†Ø¯Ø§Ø¯");

      sid = data.sid;
    }

    async function loadSession() {
      const res = await fetch(`${API_BASE}/session?sid=${encodeURIComponent(sid)}`, {
        method: "GET",
        headers: { "Accept": "application/json" },
      });

      if (!res.ok) throw new Error(`API error: ${res.status} ${res.statusText}`);
      const data = await res.json();

      if (data.error) throw new Error("API says: " + data.error);

      session = data.session;
      items = Array.isArray(data.items) ? data.items : [];
    }

    async function addTimer(durationMs, title) {
      const payload = {
        duration_ms: durationMs,
        title: title || null
      };

      const res = await fetch(`${API_BASE}/session/${encodeURIComponent(sid)}/add`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error(`API error: ${res.status} ${res.statusText}`);
      const data = await res.json();
      if (data.error) throw new Error("API says: " + data.error);
    }

    async function startAll() {
      const res = await fetch(`${API_BASE}/session/${encodeURIComponent(sid)}/start`, {
        method: "POST"
      });

      if (!res.ok) throw new Error(`API error: ${res.status} ${res.statusText}`);
      const data = await res.json();
      if (data.error) throw new Error("API says: " + data.error);
    }

    function render() {
      chips.style.display = "flex";
      chipInfo.textContent = `sid: ${sid} | status: ${statusLabel(session?.status)} | items: ${items.length}`;

      setMeta(`ÙˆØ¶Ø¹ÛŒØª: ${statusLabel(session?.status)}`);

      // Ø§Ú¯Ø± pending Ø¨ÙˆØ¯ØŒ start Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
      btnStart.style.display = (session?.status === "pending") ? "inline-block" : "none";

      if (!items.length) {
        content.innerHTML = `<div class="muted">Ù‡Ù†ÙˆØ² ØªØ§ÛŒÙ…Ø±ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ú©Ø±Ø¯ÛŒ.</div>`;
        return;
      }

      const now = Date.now();

      // pending: ÙÙ‚Ø· Ù…Ø¯Øª
      if (session.status === "pending" || !session.started_at_ms) {
        content.innerHTML = items
          .sort((a,b) => (a.order_index ?? 0) - (b.order_index ?? 0))
          .map((t, idx) => `
            <div class="card">
              <div class="title">
                <span>#${idx+1} ${t.title ? `â€” ${escapeHtml(t.title)}` : ""}</span>
                <span class="badge">Ø«Ø¨Øª Ø´Ø¯Ù‡</span>
              </div>
              <div class="time">${fmt(Number(t.duration_ms || 0))}</div>
            </div>
          `).join("");
        return;
      }

      // running: Ù‡Ù…Ù‡ Ù‡Ù…Ø²Ù…Ø§Ù†
      const startedAt = Number(session.started_at_ms);

      content.innerHTML = items
        .sort((a,b) => (a.order_index ?? 0) - (b.order_index ?? 0))
        .map((t, idx) => {
          const endAt = startedAt + Number(t.duration_ms || 0);
          const left = endAt - now;
          const isDone = left <= 0;

          return `
            <div class="card">
              <div class="title">
                <span>#${idx+1} ${t.title ? `â€” ${escapeHtml(t.title)}` : ""}</span>
                <span class="badge">${isDone ? "ØªÙ…Ø§Ù… Ø´Ø¯" : "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§"}</span>
              </div>
              <div class="time">${fmt(left)}</div>
              <div class="sub"><span>Ù…Ø¯Øª: ${fmt(Number(t.duration_ms || 0))}</span></div>
            </div>
          `;
        }).join("");
    }

    btnAdd.onclick = async () => {
      try {
        clearError();
        const timeText = inpTime.value.trim();
        const title = inpTitle.value.trim();

        const durationMs = parseTimeToMs(timeText);

        await addTimer(durationMs, title);

        inpTime.value = "";
        inpTitle.value = "";

        await loadSession();
        render();

      } catch (e) {
        showError(String(e));
      }
    };

    btnStart.onclick = async () => {
      try {
        clearError();
        await startAll();
        await loadSession();
        render();
      } catch (e) {
        showError(String(e));
      }
    };

    btnRefresh.onclick = async () => {
      try {
        clearError();
        await loadSession();
        render();
      } catch (e) {
        showError(String(e));
      }
    };

    async function boot() {
      try {
        clearError();

        creatorId = tg?.initDataUnsafe?.user?.id;
        if (!creatorId) {
          showError("user_id Ø§Ø² ØªÙ„Ú¯Ø±Ø§Ù… Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø¯Ø§Ø®Ù„ ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ø§Ø² Ú©Ù†.");
          return;
        }

        controls.style.display = "flex";
        controls2.style.display = "flex";

        await getPendingSession();
        await loadSession();
        render();

      } catch (e) {
        showError("Ø®Ø·Ø§: " + String(e));
      }
    }

    (async () => {
      await boot();

      // Ø±Ù†Ø¯Ø± Ù„Ø§ÛŒÙˆ
      setInterval(() => {
        if (session && session.status === "running") {
          render();
        }
      }, 200);

      // Ø³ÛŒÙ†Ú© Ø³Ø¨Ú©
      setInterval(async () => {
        try {
          if (sid) await loadSession();
        } catch {}
      }, 5000);
    })();
  </script>
</body>
</html>
