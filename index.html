<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Timers</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root { --bd:#e6e6e6; --muted:#6b7280; }
    body { font-family: sans-serif; padding: 14px; margin: 0; }
    h3 { margin: 0 0 8px 0; }
    .muted { color: var(--muted); font-size: 13px; margin-bottom: 10px; line-height: 1.6; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin: 10px 0 14px; }
    .pill { border:1px solid var(--bd); border-radius:999px; padding:6px 10px; font-size:13px; }
    .card {
      border: 1px solid var(--bd);
      border-radius: 14px;
      padding: 12px;
      margin: 10px 0;
    }
    .title { font-weight: 800; margin-bottom: 8px; display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .badge { font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid var(--bd); color: #111; }
    .time { font-size: 22px; font-weight: 800; letter-spacing: 1px; }
    .sub { margin-top: 8px; color: var(--muted); font-size: 13px; display:flex; gap:12px; flex-wrap:wrap; }
    .err {
      border: 1px solid #fca5a5;
      background: #fff1f2;
      color: #9f1239;
      padding: 10px;
      border-radius: 12px;
      line-height: 1.6;
      margin-top: 12px;
      white-space: pre-wrap;
    }
    .btn {
      display:inline-block;
      padding:10px 12px;
      border-radius: 12px;
      border: 1px solid var(--bd);
      background: white;
      cursor: pointer;
      font-weight: 800;
      text-decoration: none;
      color: #111;
    }
    .btn:active { transform: scale(0.99); }
    .link { text-decoration: none; color: inherit; }
  </style>
</head>

<body>
  <h3 id="pageTitle">ØªØ§ÛŒÙ…Ø±Ù‡Ø§</h3>
  <div class="muted" id="meta">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</div>

  <div class="row" id="chips" style="display:none;">
    <span class="pill" id="chipInfo"></span>
  </div>

  <div class="row" id="controls" style="display:none;">
    <button class="btn" id="btnStart" style="display:none;">â–¶ï¸ Ø´Ø±ÙˆØ¹ Ù‡Ù…Ù‡</button>
    <button class="btn" id="btnRefresh">ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
    <a class="btn" id="btnBack" href="./" style="display:none;">â¬…ï¸ Ù‡Ù…Ù‡ Ø³Ø´Ù†â€ŒÙ‡Ø§</a>
  </div>

  <div id="content"></div>
  <div id="error" class="err" style="display:none;"></div>

  <script>
    const API_BASE = "https://tg-timer-api.onrender.com";

    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand?.(); }

    function qs(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    function showError(text) {
      const el = document.getElementById("error");
      el.style.display = "block";
      el.textContent = text;
    }

    function clearError() {
      const el = document.getElementById("error");
      el.style.display = "none";
      el.textContent = "";
    }

    function setMeta(text) {
      document.getElementById("meta").textContent = text;
    }

    function fmt(ms) {
      ms = Math.max(0, ms);
      const s = Math.floor(ms / 1000);
      const hh = Math.floor(s / 3600);
      const mm = Math.floor((s % 3600) / 60);
      const ss = s % 60;
      return `${String(hh).padStart(2,'0')}.${String(mm).padStart(2,'0')}.${String(ss).padStart(2,'0')}`;
    }

    function statusLabel(status) {
      if (status === "pending") return "Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø´Ø±ÙˆØ¹";
      if (status === "running") return "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§";
      if (status === "stopped") return "Ù…ØªÙˆÙ‚Ù Ø´Ø¯Ù‡";
      if (status === "deleted") return "Ø­Ø°Ù Ø´Ø¯Ù‡";
      return status || "-";
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    const sid = qs("sid"); // Ø§Ú¯Ø± Ù†Ø¨ÙˆØ¯ => Ù„ÛŒØ³Øª Ø³Ø´Ù†â€ŒÙ‡Ø§
    const content = document.getElementById("content");
    const controls = document.getElementById("controls");
    const btnStart = document.getElementById("btnStart");
    const btnRefresh = document.getElementById("btnRefresh");
    const btnBack = document.getElementById("btnBack");
    const chips = document.getElementById("chips");
    const chipInfo = document.getElementById("chipInfo");
    const pageTitle = document.getElementById("pageTitle");

    let session = null;
    let items = [];
    let sessionsList = [];

    btnRefresh.onclick = async () => { await boot(); };

    btnStart.onclick = async () => {
      if (!sid) return;
      try {
        clearError();
        const r = await fetch(`${API_BASE}/session/${encodeURIComponent(sid)}/start`, { method: "POST" });
        const data = await r.json();
        if (data.error) { showError("Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹: " + data.error); return; }
        await loadSession();
        renderSession();
      } catch (e) {
        showError("Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹: " + String(e));
      }
    };

    async function loadSession() {
      const res = await fetch(`${API_BASE}/session?sid=${encodeURIComponent(sid)}`, {
        method: "GET", headers: { "Accept": "application/json" },
      });
      if (!res.ok) throw new Error(`API error: ${res.status} ${res.statusText}`);
      const data = await res.json();
      if (data.error) return { error: data.error };
      session = data.session;
      items = Array.isArray(data.items) ? data.items : [];
      return { ok: true };
    }

    async function loadSessionsList() {
      // Ø§Ø² ØªÙ„Ú¯Ø±Ø§Ù… user_id Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…
      const creatorId = tg?.initDataUnsafe?.user?.id;
      if (!creatorId) {
        return { error: "user_id Ø§Ø² ØªÙ„Ú¯Ø±Ø§Ù… Ù†ÛŒÙˆÙ…Ø¯. Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø±Ø§ Ø§Ø² Ø¯Ø§Ø®Ù„ ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ø§Ø² Ú©Ù†." };
      }

      const res = await fetch(`${API_BASE}/sessions_by_creator?creator_id=${encodeURIComponent(creatorId)}`, {
        method: "GET", headers: { "Accept": "application/json" },
      });

      if (!res.ok) throw new Error(`API error: ${res.status} ${res.statusText}`);
      const data = await res.json();
      sessionsList = Array.isArray(data) ? data : [];
      return { ok: true, creatorId };
    }

    function renderSessionsList(creatorId) {
      pageTitle.textContent = "Ø³Ø´Ù†â€ŒÙ‡Ø§ÛŒ Ù…Ù†";
      controls.style.display = "flex";
      btnStart.style.display = "none";
      btnBack.style.display = "none";

      chips.style.display = "flex";
      chipInfo.textContent = `user_id: ${creatorId} | sessions: ${sessionsList.length}`;

      setMeta("ÛŒÚ© Ø³Ø´Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ØªØ§ ÙˆØ§Ø±Ø¯Ø´ Ø´ÙˆÛŒ Ùˆ Start Ø¨Ø²Ù†ÛŒ.");

      if (sessionsList.length === 0) {
        content.innerHTML = `<div class="muted">Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ø³Ø´Ù†ÛŒ Ù†Ø¯Ø§Ø±ÛŒ. Ø§Ø² Ø¯Ø§Ø®Ù„ Ú¯Ø±ÙˆÙ‡ Ø¨Ø§ /add Ùˆ /run Ø¨Ø³Ø§Ø².</div>`;
        return;
      }

      content.innerHTML = sessionsList.map(s => {
        const link = `./?sid=${s.id}`;
        return `
          <a class="link" href="${link}">
            <div class="card">
              <div class="title">
                <span>#${s.id}</span>
                <span class="badge">${statusLabel(s.status)}</span>
              </div>
              <div class="sub">
                <span>items: ${s.item_count}</span>
                <span>chat_id: ${s.chat_id}</span>
              </div>
            </div>
          </a>
        `;
      }).join("");
    }

    function renderSession() {
      pageTitle.textContent = `Ø³Ø´Ù† #${sid}`;
      controls.style.display = "flex";
      btnBack.style.display = "inline-block";
      btnBack.href = "./";

      chips.style.display = "flex";
      chipInfo.textContent = `sid: ${sid} | status: ${statusLabel(session?.status)} | items: ${items.length}`;

      const chatId = tg?.initDataUnsafe?.chat?.id;
      const chatType = tg?.initDataUnsafe?.chat_type;
      setMeta(
        `ÙˆØ¶Ø¹ÛŒØª: ${statusLabel(session?.status)}`
        + (chatId ? ` | chat_id: ${chatId}` : "")
        + (chatType ? ` | chat_type: ${chatType}` : "")
      );

      // Start ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ pending Ø¨Ø§Ø´Ø¯
      btnStart.style.display = (session?.status === "pending") ? "inline-block" : "none";

      if (!items.length) {
        content.innerHTML = `<div class="muted">Ù‡ÛŒÚ† ØªØ§ÛŒÙ…Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø³Ø´Ù† Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</div>`;
        return;
      }

      const now = Date.now();

      // pending: ÙÙ‚Ø· Ù…Ø¯Øªâ€ŒÙ‡Ø§
      if (session.status === "pending" || !session.started_at_ms) {
        content.innerHTML = items
          .sort((a,b) => (a.order_index ?? 0) - (b.order_index ?? 0))
          .map((t, idx) => `
            <div class="card">
              <div class="title">
                <span>#${idx+1} ${t.title ? `â€” ${escapeHtml(t.title)}` : ""}</span>
                <span class="badge">Ø«Ø¨Øª Ø´Ø¯Ù‡</span>
              </div>
              <div class="time">${fmt(Number(t.duration_ms || 0))}</div>
            </div>
          `).join("");
        return;
      }

      // running: Ù‡Ù…Ù‡ Ù‡Ù…Ø²Ù…Ø§Ù†
      const startedAt = Number(session.started_at_ms);
      content.innerHTML = items
        .sort((a,b) => (a.order_index ?? 0) - (b.order_index ?? 0))
        .map((t, idx) => {
          const endAt = startedAt + Number(t.duration_ms || 0);
          const left = endAt - now;
          const isDone = left <= 0;
          return `
            <div class="card">
              <div class="title">
                <span>#${idx+1} ${t.title ? `â€” ${escapeHtml(t.title)}` : ""}</span>
                <span class="badge">${isDone ? "ØªÙ…Ø§Ù… Ø´Ø¯" : "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§"}</span>
              </div>
              <div class="time">${fmt(left)}</div>
              <div class="sub"><span>Ù…Ø¯Øª: ${fmt(Number(t.duration_ms||0))}</span></div>
            </div>
          `;
        }).join("");
    }

    async function boot() {
      clearError();

      try {
        if (!sid) {
          const r = await loadSessionsList();
          if (r.error) { showError(r.error); return; }
          renderSessionsList(r.creatorId);
          return;
        }

        const r = await loadSession();
        if (r.error) {
          pageTitle.textContent = `Ø³Ø´Ù† #${sid}`;
          controls.style.display = "flex";
          btnBack.style.display = "inline-block";
          btnBack.href = "./";
          btnStart.style.display = "none";
          chips.style.display = "flex";
          chipInfo.textContent = `sid: ${sid}`;
          setMeta("Ø§ÛŒÙ† sid Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.");
          showError("Ø§ÛŒÙ† sid Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ (not_found). Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ù‡Ù†ÙˆØ² Ø³Ø§Ø®ØªÙ‡ Ù†Ø´Ø¯Ù‡.");
          content.innerHTML = "";
          return;
        }

        renderSession();

      } catch (e) {
        showError("Ø®Ø·Ø§: " + String(e));
      }
    }

    // Boot + live
    (async () => {
      await boot();

      // Ù„Ø§ÛŒÙˆ ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ Ø¯Ø§Ø®Ù„ ÛŒÚ© Ø³Ø´Ù† Ù‡Ø³ØªÛŒÙ…
      setInterval(() => {
        if (sid && session && session.status === "running") {
          renderSession();
        }
      }, 200);

      // Ø³ÛŒÙ†Ú© Ø³Ø¨Ú©
      setInterval(async () => {
        if (sid) {
          try { await loadSession(); } catch {}
        }
      }, 5000);
    })();
  </script>
</body>
</html>
